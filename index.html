<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>BTM Live Tracker — Dashboard + Analytics</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togpx/0.0.6/togpx.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>

<style>
  :root { --sidebar-width: 300px; --gap:10px; }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;}
  .app {display:flex; height:100vh; width:100vw; overflow:hidden;}
  #sidebar { width:var(--sidebar-width); background:#fafafa; border-right:1px solid #ddd; padding:12px; box-sizing:border-box; transition: transform .28s ease; z-index:1100; overflow:auto;}
  #sidebar.collapsed { transform:translateX(calc(-1 * var(--sidebar-width))); }
  #mapWrap { flex:1; display:flex; flex-direction:column; position:relative; }
  #map { flex:1; min-height:300px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; justify-content:center; }
  button { padding:8px 12px; font-size:1rem; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
  .track-item { display:flex; justify-content:space-between; align-items:center; gap:6px; padding:6px; margin-bottom:8px; border-radius:8px; border:1px solid #eee; background:#fff; }
  .track-color { width:18px; height:18px; border-radius:4px; display:inline-block; margin-right:8px; vertical-align:middle; }
  .legend, #collapseBtn { position:absolute; z-index:1200; }
  #collapseBtn { top:10px; left:10px; background:#fff; border:1px solid #ccc; border-radius:6px; padding:6px; }
  .legend { bottom:12px; left:12px; background:#fff; padding:8px; border-radius:6px; border:1px solid #ddd; font-size:0.85rem; }
  .alerts { color:crimson; font-weight:600; margin-top:12px; min-height:22px;}
  #charts { display:flex; gap:12px; padding:10px; background:#fafafa; border-top:1px solid #eee; align-items:center; }
  #speedChartWrap, #activityChartWrap { flex:1; min-width:180px; background:#fff; padding:8px; border-radius:8px; border:1px solid #eee; }
  canvas { width:100% !important; height:200px !important; }
  /* mobile */
  @media (max-width:700px){ #sidebar{ position:absolute; height:100vh; left:0; top:0; } #mapWrap{ margin-left:0; } }
</style>
</head>
<body>
<div class="app">
  <div id="sidebar">
    <h2 style="margin:4px 0;">BTM Tracker</h2>
    <div style="font-size:0.9rem;color:#444;margin-bottom:8px;">Tracks (click item to pan/play)</div>
    <div id="trackList"></div>

    <div style="margin-top:8px;">
      <div class="controls" style="justify-content:flex-start">
        <button id="startRec">Start Recording</button>
        <button id="stopRec" disabled>Stop Recording</button>
        <button id="clearAlerts">Clear Alerts</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label style="font-weight:600">Geofences (circle)</label>
      <div id="geofenceList" style="margin-top:6px;font-size:0.9rem;color:#333"></div>
      <div style="margin-top:6px;">
        <input id="gfLat" placeholder="lat" style="width:70px;padding:6px"/> 
        <input id="gfLon" placeholder="lon" style="width:70px;padding:6px"/> 
        <input id="gfRad" placeholder="meters" style="width:70px;padding:6px"/>
        <button id="addGeofence">Add</button>
      </div>
    </div>

    <div class="alerts" id="alerts"></div>

    <hr style="margin:12px 0"/>

    <div style="font-size:0.9rem;color:#444;margin-bottom:6px;">Quick actions</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="showAll">Show All</button>
      <button id="hideAll">Hide All</button>
      <button id="exportAll">Export All CSV</button>
    </div>
    <div style="height:14px"></div>
    <div style="font-size:0.8rem;color:#666">Tip: use the play ▶ buttons next to each track to play, or click the colored polyline to toggle visibility.</div>
  </div>

  <div id="mapWrap">
    <button id="collapseBtn">☰</button>
    <div id="map"></div>

    <div id="charts">
      <div id="speedChartWrap">
        <div style="font-weight:600;margin-bottom:6px;">Speed & Heading (live)</div>
        <canvas id="speedChart"></canvas>
      </div>
      <div id="activityChartWrap">
        <div style="font-weight:600;margin-bottom:6px;">Activity Timeline</div>
        <canvas id="activityChart"></canvas>
      </div>
    </div>

    <div class="legend">
      <div style="font-weight:700;margin-bottom:4px;">Legend</div>
      <div>Activity: <span style="color:green">●</span> walking &nbsp; <span style="color:orange">●</span> running &nbsp; <span style="color:blue">●</span> cycling &nbsp; <span style="color:red">●</span> driving</div>
      <div style="margin-top:6px;">Alerts: ⚠️ sudden speed / sharp turns / route deviation</div>
    </div>
  </div>
</div>

<script>
/* ========== Initialization ========== */
const map = L.map('map', { preferCanvas:true }).setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OSM' }).addTo(map);

// Ensure Leaflet reflows properly on load (fixes blank map)
setTimeout(()=>map.invalidateSize(), 300);

/* ========== Storage & state ========== */
const trackStore = localforage.createInstance({ name:'BTMLiveTracker', storeName:'tracks' });

let recording = false;
let currentTrackId = null;
let currentPolyline = null;
let currentMarker = null;
let prevPoint = null;
let allTracks = {};
let polylineMap = {};        // tid -> polyline
let segmentMap = {};         // tid -> array of small polylines (activity colored)
let alertMarkers = [];
let geofences = [];          // {lat,lon,radius,leafletCircle}
let visibilityMap = {};
const colorPalette = ['#1f77b4','#9467bd','#8c564b','#e377c2','#17becf','#7f7f7f','#bcbd22','#d62728'];

/* ========== Charts setup (Chart.js) ========== */
const speedCtx = document.getElementById('speedChart').getContext('2d');
const activityCtx = document.getElementById('activityChart').getContext('2d');

const speedChart = new Chart(speedCtx, {
  type: 'line',
  data: {
    labels: [], // timestamp short
    datasets: [
      { label:'Speed (km/h)', data: [], borderColor:'#d9534f', backgroundColor:'rgba(217,83,79,0.08)', yAxisID:'y' },
      { label:'Heading (°)', data: [], borderColor:'#5bc0de', backgroundColor:'rgba(91,192,222,0.06)', yAxisID:'y2' }
    ]
  },
  options: {
    interaction: { mode:'index', intersect:false },
    scales: {
      y: { type:'linear', position:'left', title:{display:true,text:'km/h'} },
      y2: { type:'linear', position:'right', title:{display:true,text:'degrees'}, grid:{display:false}, min:0, max:360 }
    }
  }
});

// Activity timeline as bar chart: x=sequence index, y=1 (color-coded)
const activityChart = new Chart(activityCtx, {
  type:'bar',
  data:{ labels:[], datasets:[ { label:'activity', data:[], backgroundColor:[] } ] },
  options:{
    indexAxis:'x',
    plugins:{ legend:{display:false} },
    scales:{ x:{ display:false }, y:{ display:false } }
  }
});

/* ========== Utils ========== */
function toRad(v){return v*Math.PI/180;}
function toDeg(v){return v*180/Math.PI;}
function haversin
