<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Live Location Tracker (Persistent)</title>

  <!-- Leaflet CSS + JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { height:100%; width:100%; }

    #controls {
      position: fixed; top:10px; left:10px;
      z-index:9999;
      background: rgba(255,255,255,0.9);
      border-radius:8px;
      padding:6px 12px;
      box-shadow:0 0 4px rgba(0,0,0,0.2);
      display:flex;
      flex-direction: column;
      gap:4px;
    }
    button, label { font-size:14px; cursor:pointer; }
    button { background:#007bff; color:white; border:none; border-radius:6px; padding:6px 10px; }
    button:hover { background:#0056b3; }

    #legend {
      position: fixed; bottom:10px; right:10px;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow:0 0 4px rgba(0,0,0,0.2);
      font-size: 13px;
      z-index:9999;
      line-height:1.3;
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    #legend.updating { opacity:0.4; transform:translateY(6px);}
    .legend-title { font-weight:bold; margin-bottom:4px; text-align:center; }
    .gradient-bar { width:120px; height:10px; background:linear-gradient(to right, green, yellow, red); border-radius:4px; margin-bottom:4px; }
    .legend-section { margin-top:6px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="controls">
    <label><input type="checkbox" id="follow" checked> Follow live</label>
    <button id="clearHistory">üóë Clear history</button>
    <button id="downloadCSV">‚¨á Download CSV</button>
    <button id="downloadGPX">‚¨á Download GPX</button>
  </div>

  <div id="legend">
    <div class="legend-title">Altitude Gradient</div>
    <div class="gradient-bar"></div>
    <div class="legend-section"><b>Speed</b>: green ‚Üí yellow ‚Üí red</div>
  </div>

  <script>
    const map = L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'¬© OpenStreetMap'
    }).addTo(map);

    let liveMarker=null;
    let lineLayers=[];
    let pointMarkers=[];
    let lastBounds=null;

    const legend=document.getElementById('legend');
    const altLegendSpan=document.createElement('div');
    altLegendSpan.style.display='flex';
    altLegendSpan.style.justifyContent='space-between';
    document.querySelector('#legend .gradient-bar').after(altLegendSpan);

    const speedLegendSection=document.querySelector('#legend .legend-section');
    const speedRangeLabel=document.createElement('div');
    speedRangeLabel.style.fontSize='12px';
    speedRangeLabel.style.textAlign='center';
    speedRangeLabel.style.marginTop='4px';
    speedLegendSection.after(speedRangeLabel);

    // Load from localStorage
    let allPoints = JSON.parse(localStorage.getItem('allPoints') || "[]");

    function altGradientColor(alt,minAlt,maxAlt){
      if(alt==null) return '#808080';
      const ratio=Math.min(Math.max((alt-minAlt)/(maxAlt-minAlt),0),1);
      const r=Math.round(ratio*255);
      const g=Math.round(255-ratio*255);
      return `rgb(${r},${g},0)`;
    }

    function speedColor(speed,minSpeed,maxSpeed){
      if(speed==null) return 'gray';
      const ratio=Math.min(Math.max((speed-minSpeed)/(maxSpeed-minSpeed),0),1);
      if(ratio<0.33) return 'green';
      if(ratio<0.66) return 'yellow';
      return 'red';
    }

    function animateLegendUpdate(){
      legend.classList.add('updating');
      setTimeout(()=>legend.classList.remove('updating'),600);
    }

    function plotPoints(points){
      lineLayers.forEach(l=>map.removeLayer(l));
      lineLayers=[];
      pointMarkers.forEach(m=>map.removeLayer(m));
      pointMarkers=[];

      if(points.length===0) return;

      const alts = points.map(p=>p.altitude||0);
      const speeds = points.map(p=>p.speed||0);
      const minAlt = Math.min(...alts), maxAlt = Math.max(...alts);
      const minSpeed = Math.min(...speeds), maxSpeed = Math.max(...speeds);

      animateLegendUpdate();
      altLegendSpan.innerHTML=`<span>${minAlt.toFixed(0)} m</span><span>${maxAlt.toFixed(0)} m</span>`;
      speedRangeLabel.innerHTML=`<b>Speed range:</b> ${minSpeed.toFixed(1)} ‚Üí ${maxSpeed.toFixed(1)} m/s`;

      for(let i=1;i<points.length;i++){
        const p1=points[i-1], p2=points[i];
        const color=altGradientColor(p2.altitude,minAlt,maxAlt);
        const seg=L.polyline([[p1.lat,p1.lon],[p2.lat,p2.lon]],{color,weight:3}).addTo(map);
        lineLayers.push(seg);
      }

      points.forEach(p=>{
        const popup=`<b>${p.ts}</b><br>
          Lat: ${p.lat.toFixed(6)}<br>
          Lon: ${p.lon.toFixed(6)}<br>
          Accuracy: ${p.accuracy||'N/A'} m<br>
          Altitude: ${p.altitude||'N/A'} m<br>
          Speed: ${p.speed||'N/A'} m/s`;
        const m=L.circleMarker([p.lat,p.lon],{radius:4,color:'blue'}).bindPopup(popup).addTo(map);
        pointMarkers.push(m);
      });

      const last=points[points.length-1];
      const latestPos=[last.lat,last.lon];
      const color=speedColor(last.speed,minSpeed,maxSpeed);
      const popup=`<b>üìç Latest</b><br>${last.ts}<br>
        Lat: ${last.lat.toFixed(6)}<br>
        Lon: ${last.lon.toFixed(6)}<br>
        Accuracy: ${last.accuracy||'N/A'} m<br>
        Altitude: ${last.altitude||'N/A'} m<br>
        Speed: ${last.speed||'N/A'} m/s`;

      if(!liveMarker){
        liveMarker=L.circleMarker(latestPos,{radius:8,color,fillColor:color,fillOpacity:0.9}).bindPopup(popup).addTo(map);
      } else{
        liveMarker.setLatLng(latestPos);
        liveMarker.setStyle({color,fillColor:color});
        liveMarker.setPopupContent(popup);
      }

      const follow=document.getElementById('follow').checked;
      if(follow) map.panTo(latestPos,{animate:true,duration:1.0});
      else if(!lastBounds) map.fitBounds(L.featureGroup(lineLayers).getBounds());
      lastBounds=L.featureGroup(lineLayers).getBounds();
    }

    // Geolocation
    function success(pos){
      const crd = pos.coords;
      const now = new Date().toLocaleTimeString();
      const p={lat:crd.latitude, lon:crd.longitude, altitude:crd.altitude||0, speed:crd.speed||0, accuracy:crd.accuracy||0, ts:now};
      allPoints.push(p);
      localStorage.setItem('allPoints', JSON.stringify(allPoints));
      plotPoints(allPoints);
    }

    function error(err){
      console.warn(`ERROR(${err.code}): ${err.message}`);
      alert("Location access denied or unavailable.");
    }

    if(navigator.geolocation){
      navigator.geolocation.watchPosition(success,error,{enableHighAccuracy:true, maximumAge:0, timeout:5000});
    } else {
      alert("Geolocation not supported by your browser.");
    }

    // Buttons
    document.getElementById('clearHistory').onclick = ()=>{
      allPoints=[];
      localStorage.removeItem('allPoints');
      plotPoints(allPoints);
    };

    function downloadCSV(){
      if(allPoints.length===0) return alert("No data to download");
      let csv="timestamp,lat,lon,altitude,speed,accuracy\n";
      allPoints.forEach(p=>{csv+=`${p.ts},${p.lat},${p.lon},${p.altitude},${p.speed},${p.accuracy}\n`;});
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download="track.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadGPX(){
      if(allPoints.length===0) return alert("No data to download");
      let gpx='<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="LiveTracker">\n<trk><name>My Track</name><trkseg>\n';
      allPoints.forEach(p=>{
        const time = new Date().toISOString();
        gpx+=`<trkpt lat="${p.lat}" lon="${p.lon}"><ele>${p.altitude}</ele><time>${time}</time></trkpt>\n`;
      });
      gpx+='</trkseg></trk>\n</gpx>';
      const blob=new Blob([gpx],{type:'application/gpx+xml'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download="track.gpx";
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('downloadCSV').onclick = downloadCSV;
    document.getElementById('downloadGPX').onclick = downloadGPX;

    // Draw previously saved points on load
    plotPoints(allPoints);

  </script>
</body>
</html>
