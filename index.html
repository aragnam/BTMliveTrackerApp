<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BTM Live Tracker ‚Äî Enhanced Forensic Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet / libs -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togpx/0.0.6/togpx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root{--sidebar-width:320px}
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    }
    .app{display:flex;height:100vh;overflow:hidden}
    #sidebar{
      width:var(--sidebar-width);
      min-width:260px;
      background:#f8fafc;
      border-right:1px solid #e6eef6;
      padding:12px;
      box-sizing:border-box;
      overflow:auto;
      transition:transform .22s ease;
      z-index:1100;
    }
    #sidebar.collapsed{transform:translateX(calc(-1 * var(--sidebar-width)))}
    #mapWrap{flex:1;display:flex;flex-direction:column;position:relative}
    #map{height:62vh;min-height:360px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    button{
      background:#fff;
      border:1px solid #cbd5e1;
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size:0.9rem;
    }
    button.small{padding:6px 8px;font-size:0.8rem}
    .track-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px;
      border-radius:8px;
      background:#fff;
      border:1px solid #e6eef6;
      margin-bottom:8px;
      font-size:0.85rem;
    }
    .track-meta{display:flex;align-items:center;gap:8px}
    .track-color{width:18px;height:18px;border-radius:4px;display:inline-block}
    .legend{
      position:absolute;left:12px;bottom:12px;
      background:#fff;padding:8px;border-radius:8px;
      border:1px solid #e6eef6;z-index:1200;font-size:0.85rem
    }
    .alerts{color:#b91c1c;font-weight:600;margin-top:8px;font-size:0.9rem}
    #charts{display:flex;gap:12px;padding:10px;background:#ffffff;border-top:1px solid #eef2f7}
    #speedWrap,#activityWrap{
      flex:1;min-width:200px;background:#fff;border-radius:8px;
      border:1px solid #e6eef6;padding:8px
    }
    .chartCanvas{
      width:100% !important;
      height:160px !important;
    }
    .footer-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .searchrow{display:flex;gap:8px;margin-top:8px}
    pre#latest{
      background:#f7f7f7;padding:8px;border-radius:6px;
      overflow:auto;font-size:0.8rem;white-space:pre-wrap;
    }
    .quality-indicator {
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      margin-right:4px;
    }
    .quality-good{background:#10b981}
    .quality-medium{background:#f59e0b}
    .quality-poor{background:#ef4444}
    @media(max-width:900px){
      #sidebar{position:absolute;z-index:1300;height:100vh}
      #map{height:52vh}
    }
  </style>
</head>
<body>
<div class="app">
  <aside id="sidebar">
    <h2 style="margin:0 0 8px 0">BTM Live Tracker ‚Äî Forensic Mode</h2>
    <p style="font-size:0.85rem;color:#475569;margin-top:0">
      Open this page, tap <strong>Start</strong> and allow location access.
      <br><strong>Enhanced:</strong> Raw data + Quality scoring + Layered storage
    </p>

    <!-- Simple-mode buttons + dashboard extras -->
    <div class="controls">
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="exportBtn" class="small" disabled>Export (session)</button>
      <button id="copyBtn" class="small" disabled>Copy latest</button>
      <button id="trainAI" class="small">Train Predictor</button>
      <div style="font-size:0.75rem;color:#475569;">
        Scenario for this run:
        <select id="scenarioSelect" style="font-size:0.75rem;padding:2px 4px;border-radius:4px;border:1px solid #cbd5e1;">
          <option value="ONLINE_FOREGROUND">Test A ‚Äì Data ON, foreground</option>
          <option value="OFFLINE_FOREGROUND">Test B ‚Äì Data OFF, foreground</option>
          <option value="OTHER">Other / mixed</option>
        </select>
      </div>
      <!-- NEW: Power mode selector -->
      <div style="font-size:0.75rem;color:#475569;">
        Power mode:
        <select id="powerModeSelect"
                style="font-size:0.75rem;padding:2px 4px;border-radius:4px;border:1px solid #cbd5e1;">
          <option value="high">High detail (forensic)</option>
          <option value="balanced" selected>Balanced</option>
          <option value="battery">Battery saver</option>
        </select>
      </div>
    </div>

    <!-- Simple-mode latest position -->
    <div>
      <div style="font-weight:600;font-size:0.9rem;margin-bottom:4px">Latest position</div>
      <pre id="latest">No position yet.</pre>
    </div>

    <hr style="margin:10px 0;border:none;border-top:1px solid #eef2f7"/>

    <!-- Activity summary for investigators -->
    <div id="activitySummary" style="font-size:0.85rem;color:#334155;margin-bottom:8px;">
      <!-- Filled by JS -->
    </div>

    <!-- Dashboard: Tracks -->
    <div style="font-size:0.9rem;color:#334155;margin-bottom:6px;font-weight:600">Saved tracks</div>
    <div id="trackList" aria-live="polite" style="margin-bottom:8px"></div>

    <!-- Dashboard: Geofences -->
    <div style="margin-top:8px">
      <div style="font-weight:600;margin-bottom:6px;font-size:0.9rem">Geofences</div>
      <div id="geofenceList" style="font-size:0.85rem;color:#334155;margin-bottom:4px"></div>
      <div class="searchrow">
        <input id="gfLat" placeholder="lat" style="width:82px;padding:6px;border-radius:6px;border:1px solid #cbd5e1;font-size:0.8rem"/>
        <input id="gfLon" placeholder="lon" style="width:82px;padding:6px;border-radius:6px;border:1px solid #cbd5e1;font-size:0.8rem"/>
        <input id="gfRad" placeholder="meters" style="width:82px;padding:6px;border-radius:6px;border:1px solid #cbd5e1;font-size:0.8rem"/>
        <button id="addGeofence" class="small">Add</button>
      </div>
    </div>

    <div class="alerts" id="alerts" role="status"></div>

    <hr style="margin:10px 0;border:none;border-top:1px solid #eef2f7"/>

    <div style="font-weight:600;margin-bottom:6px;font-size:0.9rem">Quick actions</div>
    <div class="footer-actions">
      <button id="showAll"   class="small">Show all tracks</button>
      <button id="hideAll"   class="small">Hide all</button>
      <button id="exportAll" class="small">Export all (CSV)</button>
      <button id="clearAll"  class="small">Delete all</button>
      <button id="simulate"  class="small">Add demo track</button>
      <!-- NEW investigator tools -->
      <button id="bundleBtn"  class="small">Investigation ZIP</button>
      <button id="summaryBtn" class="small">Case summary</button>
    </div>

    <div style="margin-top:12px;font-size:0.8rem;color:#64748b">
      Tip: allow location in the browser. Train Predictor once you have several tracks.
    </div>
  </aside>

  <main id="mapWrap">
    <button id="collapseBtn"
      style="position:absolute;left:12px;top:12px;z-index:1300;border-radius:8px;
             padding:6px 10px;background:#fff;border:1px solid #eef2f7;cursor:pointer">
      ‚ò∞
    </button>

    <!-- NEW: follow-live toggle -->
    <button id="followBtn"
      style="position:absolute;left:60px;top:12px;z-index:1300;border-radius:8px;
             padding:6px 10px;background:#fff;border:1px solid #eef2f7;cursor:pointer">
      üîí Follow ON
    </button>
   
    <!-- Battery indicator + suggested mode -->
    <div id="batteryBanner"
      style="position:absolute;right:12px;top:12px;z-index:1300;
             padding:6px 10px;border-radius:8px;
             background:#f9fafb;border:1px solid #e5e7eb;
             font-size:0.75rem;color:#111827;">
      Battery: unknown ‚Äì current: balanced
    </div>
    
    <!-- Tiny one-line hint when suggestion flips -->
    <div id="batteryHint"
      style="position:absolute;right:12px;top:40px;z-index:1300;
             padding:3px 6px;border-radius:999px;
             background:#111827;color:#f9fafb;
             font-size:0.7rem;opacity:0;transition:opacity 0.25s;">
      <!-- filled by JS -->
    </div>

    <div id="map" aria-label="Map"></div>

    <div id="charts">
      <div id="speedWrap">
        <div style="font-weight:600;margin-bottom:6px;font-size:0.9rem">Speed &amp; Heading (live)</div>
        <canvas id="speedChart" class="chartCanvas"></canvas>
      </div>
      <div id="activityWrap">
        <div style="font-weight:600;margin-bottom:6px;font-size:0.9rem">Activity timeline</div>
        <canvas id="activityChart" class="chartCanvas"></canvas>
      </div>
    </div>

    <div class="legend">
      <div style="font-weight:700;margin-bottom:6px">Legend</div>
      <div>
        <span style="color:#6b7280">‚óè</span> Stationary&nbsp;
        <span style="color:#16a34a">‚óè</span> Walking&nbsp;
        <span style="color:#f97316">‚óè</span> Running&nbsp;
        <span style="color:#2563eb">‚óè</span> Cycling&nbsp;
        <span style="color:#dc2626">‚óè</span> Driving
      </div>
      <div style="margin-top:6px;font-size:0.8rem">
        Quality: <span class="quality-indicator quality-good"></span>Good 
        <span class="quality-indicator quality-medium"></span>Medium 
        <span class="quality-indicator quality-poor"></span>Poor
      </div>
      <div style="margin-top:6px;font-size:0.8rem">
        Alerts: ‚ö†Ô∏è sudden speed, sharp turn, route deviation, geofence
      </div>
    </div>
  </main>
</div>
 
  <!-- Load obfuscated tracker code (production) -->
<script src="btm-tracker.obf.js"></script>

<!-- For local debugging: temporarily enable this line instead -->
<!-- <script src="btm-tracker.js"></script> -->
  
</body>
</html>


</body>
</html>
